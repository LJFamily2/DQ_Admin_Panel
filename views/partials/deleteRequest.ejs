<head>
  <!-- Tippy -->
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <!-- Bootstrap CSS and JS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</head>

<button class="btn btn-outline-danger mb-3" data-bs-target="#deletionRequestsModal" data-bs-toggle="modal">
  Yêu cầu xóa
</button>

<!-- Modal for displaying the deletionRequests -->
<div class="modal fade" id="deletionRequestsModal" tabindex="-1" aria-labelledby="deletionRequestsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deletionRequestsModalLabel">
          Yêu cầu xóa dữ liệu
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <% if (deletionRequests.length > 0) { %>

        <% if(user.role === 'Admin' || user.role === 'Quản lý') { %>
        <button type="button" class="btn btn-danger mb-2" data-bs-toggle="modal" data-bs-target="#deleteAll" style="width: max-content">
          Xóa tất cả thông tin
        </button>
        <% } %>
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <% if(user.role === "Admin" || user.role === "Quản lý"){ %>
              <th>Thời gian</th>
              <th>Người yêu cầu</th>
              <th>Lý do</th>
              <th>Dữ liệu</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
              <% } else { %>
              <th>Thời gian</th>
              <th>Lý do</th>
              <th>Dữ liệu</th>
              <th>Trạng thái</th>
              <% } %>

            </tr>
          </thead>
          <tbody>
            <% deletionRequests.forEach(request => { %>
            <% 
              // Check if the user is Admin or Quản lý 
              const isAdminOrDirector = user.role === 'Admin' || user.role === 'Quản lý'; 
              // Check if the request is made by the current user 
              const isUserRequest = request.requestedBy && request.requestedBy._id.toString() === user._id.toString(); 
              %>
            <% if(isAdminOrDirector || isUserRequest) { %>
            <tr>
              <td><%= new Date(request.requestedAt).toLocaleString() %></td>
              <% if(isAdminOrDirector) { %> <td><%= request.requestedBy.username %></td><% } %>
              <td><%= request.reason %></td>
              <td>
                <button class="btn btn-link p-0" data-bs-target="#dataDetailModal<%= request._id %>" data-bs-toggle="modal">
                  Chi tiết
                </button>
              </td>
              <td>
                <span class="<%= request.status === 'pending' || request.status === 'rejected' ? 'text-danger' : 'text-success' %>">
                  <%= request.status === 'pending' ? 'Chờ xử lý' :
                  request.status === 'rejected' ? 'Từ chối' :'Hoàn tất' %>
                </span>
              </td>
              <% if(isAdminOrDirector) { %>
              <td style="display: flex; align-items: center; justify-content: space-evenly;">
                <button type="button" class="btn" data-bs-target="#ActionHistoryDeletion<%= request._id %>" data-bs-toggle="modal">
                  <i class="bi bi-check-square-fill text-success tooltip-wrapper" data-tippy-content="Chấp nhận xóa" style="cursor: pointer"></i>
                </button>
                <form action="/du-lieu-hang-ngay/rejectDeletionRequest/<%= request._id %>?_method=POST" method="post">
                  <button type="submit" class="btn">
                    <i class="bi bi-x-square-fill text-danger tooltip-wrapper" data-tippy-content="Từ chối xóa" style="cursor: pointer"></i>
                  </button>
                </form>
              </td>
              <% } %>
            </tr>
            <% } %>
            <% }) %>
          </tbody>
        </table>
        <% } else { %>
        <p>Không có dữ liệu.</p>
        <% } %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Đóng
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modals for viewing the data details -->
<% deletionRequests.forEach(request => { %>
<div class="modal fade" id="dataDetailModal<%= request._id %>" tabindex="-1" aria-labelledby="dataDetailModalLabel<%= request._id %>" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataDetailModalLabel<%= request._id %>">
          Chi tiết dữ liệu
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Display the data details here -->
        <p>
          <strong>Thời gian:</strong> <%= new Date(request.requestedAt).toLocaleString() %>
        </p>
        <p>
          <strong>Người yêu cầu:</strong> <%= request.requestedBy.username %> (<%= request.requestedBy.role %>)
        </p>
        <p><strong>Lý do:</strong> <%= request.reason %></p>
        <p>
          <strong>Trạng thái:</strong> <%= request.status === 'pending' ? 'Chờ xử lý' : request.status === 'rejected' ? 'Từ chối' :'Hoàn tất' %>
        </p>
        <% if (request.dataId && request.rawMaterial) { %>
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th colspan="3">Mủ nước</th>
              <th>Mủ tạp</th>
              <th>Mủ ké</th>
              <th>Mủ đông</th>
              <th rowspan="2">Khác</th>
            </tr>
            <tr>
              <th>SL</th>
              <th>Hàm lượng</th>
              <th>Quy khô</th>
              <th>SL</th>
              <th>SL</th>
              <th>SL</th>
            </tr>
          </thead>
          <tr>
            <% request.rawMaterial.forEach(material => { %>
            <% if(material.name === "Mủ nước"){ %>
            <td><%= material.quantity %></td>
            <td><%= material.percentage %></td>
            <td><%= material.quantity * material.percentage / 100 %></td>
            <% } else { %>
            <td><%= material.quantity %></td>
            <% } %>
            <% }) %>
            <td><%= request.note %></td>
          </tr>
        </table>
        <% } else { %>
        <p>No raw materials found.</p>
        <% } %>
        <!-- Add more details as needed -->
      </div>
      <div class="modal-footer">
        <a class="btn btn-secondary" data-bs-toggle="modal" href="#deletionRequestsModal" role="button">
          Quay lại
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Modal for deleting the data -->
<div class="modal fade" id="ActionHistoryDeletion<%= request._id %>" aria-hidden="true" aria-labelledby="ActionHistoryDeletionLabel<%= request._id %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ActionHistoryDeletionLabel<%= request._id %>">
          Xác nhận xóa
        </h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/nhap-du-lieu/nguyen-lieu/deleteData/<%= request.dataId._id %>" method="post">
        <div class="modal-body">
          Bạn có chắc chắn muốn xóa dữ liệu này không?
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Xác nhận</button>
          <a class="btn btn-secondary" data-bs-toggle="modal" href="#deletionRequestsModal" role="button">
            Quay lại
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
<% }) %>

<!-- Modal for delete all data  -->
<div class="modal fade" id="deleteAll" aria-hidden="true" aria-labelledby="deleteAllLabel" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="deleteAllLabel">Xác nhận xóa</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/du-lieu-hang-ngay/<%= slug %>/removeAllDeletionRequests?_method=DELETE" method="post">
        <div class="modal-body">
          Bạn có chắc chắn muốn xóa tất cả dữ liệu không? Hành động này không
          thể hoàn tác.
        </div>
        <div class="modal-footer">
          <% if(user.role === 'Admin' || user.role === 'Quản lý'){ %>
          <button type="submit" class="btn btn-danger">Xác nhận</button>
          <% } else { %>
          <div class="tooltip-wrapper" data-tippy-content="Bạn không có quyền thao tác" tabindex="0">
            <button type="button" class="btn btn-danger" disabled>
              Xác nhận
            </button>
          </div>
          <% } %>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    tippy('.tooltip-wrapper');
  });
</script>